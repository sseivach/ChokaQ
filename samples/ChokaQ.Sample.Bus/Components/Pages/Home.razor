@page "/"
@rendermode InteractiveServer
@using ChokaQ.Abstractions
@using ChokaQ.Abstractions.Jobs
@using ChokaQ.Abstractions.Storage
@using ChokaQ.Sample.Bus.Jobs
@inject IChokaQQueue Queue

<PageTitle>ChokaQ Launcher</PageTitle>

<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-8">

            <div class="text-center mb-5">
                <h1 class="display-5 fw-bold text-primary">ChokaQ Launcher</h1>
                <p class="lead text-muted">Generate load and monitor results in real-time.</p>
            </div>

            <div class="card shadow-sm mb-4">
                <div class="card-header bg-white py-3">
                    <h5 class="mb-0 fw-bold">🚀 Job Generator</h5>
                </div>
                <div class="card-body p-4">

                    <div class="row g-3 mb-4">

                        <div class="col-md-12">
                            <label class="form-label fw-bold small">Job Type</label>
                            <select class="form-select" @bind="selectedJobType">
                                <optgroup label="Mailing (Chaos Testing 🧨)">
                                    <option value="email">Send Email (70% Crash Chance)</option>
                                    <option value="sms">Send SMS</option>
                                </optgroup>
                                <optgroup label="Reporting">
                                    <option value="rep_emp">Employee Report</option>
                                    <option value="rep_sales">Sales Report</option>
                                    <option value="rep_exp">Expense Report</option>
                                </optgroup>
                                <optgroup label="System Maintenance">
                                    <option value="health">Health Check</option>
                                    <option value="cleanup">Data Cleanup</option>
                                </optgroup>
                            </select>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label fw-bold small">Job Count</label>
                            <input type="number" class="form-control" @bind="count" min="1" max="10000" />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold small">Priority (0-100)</label>
                            <input type="number" class="form-control" @bind="priority" />
                        </div>
                    </div>

                    <div class="d-grid gap-2">
                        <button class="btn btn-primary btn-lg fw-bold" @onclick="Launch" disabled="@isLoading">
                            @if (isLoading)
                            {
                                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                                <span>Generating...</span>
                            }
                            else
                            {
                                <span>🔥 FIRE JOBS</span>
                            }
                        </button>
                    </div>

                    @if (!string.IsNullOrEmpty(statusMessage))
                    {
                        <div class="alert alert-success mt-3 mb-0 text-center">
                            @statusMessage
                        </div>
                    }
                </div>
            </div>

            <div class="text-center">
                <a href="/chokaq" target="_blank" class="btn btn-outline-dark px-4 py-2">
                    📊 Open Dashboard in New Tab
                </a>
            </div>

        </div>
    </div>
</div>

@code {
    private string selectedJobType = "email"; // Default to a real business job
    private int count = 1;
    private int priority = 10;
    private bool isLoading = false;
    private string? statusMessage;

    private async Task Launch()
    {
        isLoading = true;
        statusMessage = null;

        await Task.Run(async () =>
        {
            var options = new ParallelOptions { MaxDegreeOfParallelism = 50 };
            await Parallel.ForEachAsync(Enumerable.Range(0, count), options, async (i, ct) =>
            {
                IChokaQJob job = selectedJobType switch
                {
                    // Mailing
                    "email" => new EmailJob($"user{i}@test.com", "Weekly Update"),
                    "sms" => new SmsJob("+15550009999", "Your code is 1234"),

                    // Reporting
                    "rep_emp" => new EmployeeReportJob("IT_Dept"),
                    "rep_sales" => new SalesReportJob(2026, 1),
                    "rep_exp" => new ExpenseReportJob("Travel"),

                    // System Maintenance
                    "health" => new HealthCheckJob("PaymentGateway"),
                    "cleanup" => new CleanupJob(30),

                    _ => throw new InvalidOperationException($"Unknown Job Type: {selectedJobType}")
                };

                // Auto-route to specific queues based on category
                string queue = selectedJobType switch
                {
                    "email" or "sms" => "emails",
                    "health" or "cleanup" => "critical",
                    "rep_emp" or "rep_sales" or "rep_exp" => "background",
                    _ => "default"
                };

                await Queue.EnqueueAsync(job, priority, queue, "Launcher", ct: ct);
            });
        });

        isLoading = false;
        statusMessage = $"Enqueued {count} jobs ({selectedJobType})!";
    }
}