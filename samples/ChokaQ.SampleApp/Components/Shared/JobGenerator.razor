@using System.Net.Http
@using System.Net.Http.Json
@inject IHttpClientFactory HttpClientFactory
@inject NavigationManager Navigation

<div class="card bg-dark text-white border-secondary mb-4 shadow-sm">
    <div class="card-header border-secondary d-flex justify-content-between align-items-center">
        <h5 class="mb-0">🏭 Workload Generator</h5>
    </div>
    <div class="card-body">

        <div class="d-flex gap-3 align-items-end mb-3">
            <div class="flex-grow-1">
                <label class="form-label text-secondary small">Batch Size</label>
                <select class="form-select bg-dark text-white border-secondary" @bind="selectedCount">
                    @for (int i = 10; i <= 100; i += 10)
                    {
                        <option value="@i">@i Items</option>
                    }
                </select>
            </div>

            <button class="btn btn-primary" @onclick="SendBatch" disabled="@isLoading">
                @if (isLoading)
                {
                    <span class="spinner-border spinner-border-sm me-2"></span>
                    <span>Uploading...</span>
                }
                else
                {
                    <span>🚀 Send Batch</span>
                }
            </button>
        </div>

        @if (!string.IsNullOrEmpty(statusMessage))
        {
            <div class="alert @statusClass d-flex align-items-center" role="alert">
                <div>@statusMessage</div>
            </div>
        }
    </div>
</div>

@code {
    private int selectedCount = 10;
    private bool isLoading = false;

    // UI State for feedback
    private string? statusMessage;
    private string statusClass = "alert-info";

    private async Task SendBatch()
    {
        isLoading = true;
        statusMessage = null; // Clear previous messages

        try
        {
            var client = HttpClientFactory.CreateClient();
            client.BaseAddress = new Uri(Navigation.BaseUri);

            var payloads = Enumerable.Range(1, selectedCount)
                .Select(i => $"Order #{Random.Shared.Next(1000, 9999)} processed at {DateTime.Now:T}")
                .ToList();

            // 1. Capture the response
            var response = await client.PostAsJsonAsync("/api/jobs/batch", payloads);

            // 2. Check if it actually worked
            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<BatchResult>();
                statusClass = "alert-success";
                statusMessage = $"✅ Success! {result?.Message}";
            }
            else
            {
                // 3. If API failed, read why
                var error = await response.Content.ReadAsStringAsync();
                statusClass = "alert-danger";
                statusMessage = $"❌ API Error ({response.StatusCode}): {error}";
            }
        }
        catch (Exception ex)
        {
            // 4. Catch network/SSL errors
            statusClass = "alert-danger";
            statusMessage = $"💥 Exception: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    // Helper class to deserialise the OK response
    private class BatchResult
    {
        public string? Message { get; set; }
        public List<string>? JobIds { get; set; }
    }
}