@using ChokaQ.Abstractions.Enums
@using ChokaQ.Dashboard.Models
@using Microsoft.AspNetCore.SignalR.Client

<tr class="cq-job-row" @onclick="SelectJob">
    <td class="font-monospace fw-bold" style="color: var(--cq-info); font-size: 0.85rem;" title="@Job.Id">
        @Job.Id.Substring(0, 8)...
    </td>

    <td>
        <span class="fw-bold small" style="color: var(--cq-text-muted)">
            @(Job.CreatedBy ?? "System")
        </span>
    </td>

    <td>
        <span class="badge bg-dark border border-secondary text-light font-monospace">
            @Job.Type
        </span>
    </td>

    <td class="small font-monospace text-muted">
        @if (Job.StartedAtUtc.HasValue)
        {
            @Job.StartedAtUtc.Value.ToLocalTime().ToString("MM/dd/yyyy-HH:mm:ss")
        }
        else
        {
            <span>-</span>
        }
    </td>

    <td>
        @if (Job.Status == JobStatus.Processing)
        {
            <span class="badge" style="background-color: var(--cq-warning); color: #000;">PROCESSING</span>
        }
        else if (Job.Status == JobStatus.Succeeded)
        {
            <span class="badge" style="background-color: var(--cq-success); color: #fff;">SUCCEEDED</span>
        }
        else if (Job.Status == JobStatus.Failed)
        {
            <span class="badge" style="background-color: var(--cq-danger); color: #fff;">FAILED</span>
        }
        else if (Job.Status == JobStatus.Cancelled)
        {
            <span class="badge bg-secondary text-white">CANCELLED</span>
        }
        else
        {
            <span class="badge" style="background-color: var(--cq-text-muted); color: #fff;">PENDING</span>
        }
    </td>

    <td>
        @if (Job.Status == JobStatus.Processing)
        {
            <div class="progress" style="height: 4px; background-color: var(--cq-border);">
                <div class="progress-bar"
                     role="progressbar"
                     style="width: @(Job.Progress)%; background-color: var(--cq-info); transition: width 0.3s ease;">
                </div>
            </div>
            <div style="font-size: 0.7em; margin-top: 2px;">@Job.Progress%</div>
        }
        else if (Job.Status == JobStatus.Succeeded)
        {
            <div class="progress" style="height: 4px; background-color: var(--cq-border);">
                <div class="progress-bar" style="width: 100%; background-color: var(--cq-success);"></div>
            </div>
        }
        else
        {
            <span style="color: var(--cq-text-muted)">-</span>
        }
    </td>

    <td>
        @if (Job.Attempts > 1)
        {
            <span class="badge" style="border: 1px solid var(--cq-border); color: var(--cq-text);">@Job.Attempts</span>
        }
        else
        {
            <span style="color: var(--cq-text-muted)">1</span>
        }
    </td>

    <td class="font-monospace small">
        @FormatDuration(Job.Duration)
    </td>

    <td class="text-end">
        @if (Job.Status == JobStatus.Processing || Job.Status == JobStatus.Pending)
        {
            <button class="btn btn-sm btn-outline-danger me-2"
                    title="Stop Job"
                    @onclick="CancelJob"
                    @onclick:stopPropagation="true">
                🛑 Stop
            </button>
        }

        @if (Job.Status == JobStatus.Succeeded ||
                Job.Status == JobStatus.Failed ||
                Job.Status == JobStatus.Cancelled)
        {
            <button class="btn btn-sm btn-outline-primary me-2"
                    title="Restart Job"
                    @onclick="RestartJob"
                    @onclick:stopPropagation="true">
                🔄 Restart
            </button>
        }
    </td>
</tr>

<style>
    /* Inline style for the row pointer, could be moved to css file */
    .cq-job-row {
        cursor: pointer;
        transition: background-color 0.2s;
    }
</style>

@code {
    [Parameter] public required JobViewModel Job { get; set; }

    [Parameter] public EventCallback<string> OnCancelRequested { get; set; }

    [Parameter] public EventCallback<string> OnRestartRequested { get; set; }

    // New callback for selection
    [Parameter] public EventCallback<string> OnSelected { get; set; }

    private async Task CancelJob()
    {
        await OnCancelRequested.InvokeAsync(Job.Id);
    }

    private async Task RestartJob()
    {
        await OnRestartRequested.InvokeAsync(Job.Id);
    }

    private async Task SelectJob()
    {
        await OnSelected.InvokeAsync(Job.Id);
    }

    private string FormatDuration(TimeSpan? duration)
    {
        if (!duration.HasValue || duration.Value == TimeSpan.Zero) return "-";

        // Less than 1 second, show ms
        if (duration.Value.TotalSeconds < 1)
            return $"{duration.Value.TotalMilliseconds:F0}ms";

        // Less than 1 minute, show seconds and ms
        if (duration.Value.TotalMinutes < 1)
            return $"{duration.Value.Seconds}s {duration.Value.Milliseconds}ms";

        // Default format for longer durations
        return $"{duration.Value.Minutes}m {duration.Value.Seconds}s";
    }
}