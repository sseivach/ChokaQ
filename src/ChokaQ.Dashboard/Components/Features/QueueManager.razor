<div class="card cq-card shadow-sm mb-4">
    <div class="card-header py-2 d-flex justify-content-between align-items-center"
         style="background-color: var(--cq-panel-bg); border-bottom: 1px solid var(--cq-border);">
        <div class="d-flex align-items-center gap-2">
            <h6 class="mb-0 fw-bold small text-uppercase" style="color: var(--cq-text-muted)">
                🚦 Queue Traffic
            </h6>
            @if (_queues.Any())
            {
                <span class="badge bg-secondary rounded-pill" style="font-size: 0.65rem;">@_visibleQueues.Count()</span>
            }
        </div>

        @if (_hiddenQueues.Any())
        {
            <button class="btn btn-sm btn-link text-decoration-none small p-0"
                    style="font-size: 0.75rem;"
                    @onclick="ShowAllQueues">
                Show Hidden (@_hiddenQueues.Count)
            </button>
        }
    </div>

    <div class="table-responsive">
        @if (!_queues.Any())
        {
            <div class="p-4 text-center text-muted small">
                @if (_isLoading)
                {
                    <span>⏳ Loading queues...</span>
                }
                else
                {
                    <span>No active queues found. Send a job to 'default' queue to see it here.</span>
                }
            </div>
        }
        else
        {
            <table class="table mb-0 text-nowrap" style="color: var(--cq-text); font-size: 0.75rem;">
                <thead style="background-color: rgba(0,0,0,0.02); text-transform: uppercase;">
                    <tr>
                        <th class="ps-3" style="width: 20%">Queue</th>
                        <th class="text-center" style="width: 5%">Pause</th>

                        <th class="text-end" style="width: 10%; color: var(--cq-info);">Pend</th>
                        <th class="text-end" style="width: 10%; color: #6f42c1;">Buff</th>
                        <th class="text-end" style="width: 10%; color: var(--cq-warning);">Proc</th>
                        <th class="text-end" style="width: 10%; color: var(--cq-success);">Succ</th>
                        <th class="text-end" style="width: 10%; color: var(--cq-danger);">Fail</th>
                        <th class="text-end" style="width: 10%; color: var(--cq-text-muted);">Canc</th>

                        <th class="text-end" style="width: 10%">Active</th>
                        <th class="text-end pe-3" style="width: 5%"></th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var q in _visibleQueues)
                    {
                        var isActive = q.PendingCount > 0 || q.ProcessingCount > 0 || q.FetchedCount > 0;

                        <tr style="border-bottom: 1px solid var(--cq-border); transition: background-color 0.3s;">

                            <td class="ps-3 align-middle">
                                <span class="fw-bold font-monospace">@q.Name</span>
                                @if (q.IsPaused)
                                {
                                    <span class="badge bg-danger ms-2" style="font-size: 0.6em;">PAUSED</span>
                                }
                            </td>

                            <td class="align-middle text-center">
                                <div class="form-check form-switch d-inline-block" style="min-height: 0;">
                                    <input class="form-check-input" type="checkbox"
                                           style="width: 2em; height: 1em; margin-top: 0;"
                                           id="q_@q.Name"
                                           checked="@(!q.IsPaused)"
                                           @onchange="@(e => ToggleQueue(q.Name, (bool)e.Value!))">
                                </div>
                            </td>

                            <td class="align-middle text-end font-monospace @(q.PendingCount > 0 ? "fw-bold" : "text-muted")">
                                @q.PendingCount.ToString("N0")
                            </td>

                            <td class="align-middle text-end font-monospace @(q.FetchedCount > 0 ? "fw-bold" : "text-muted")">
                                @q.FetchedCount.ToString("N0")
                            </td>

                            <td class="align-middle text-end font-monospace @(q.ProcessingCount > 0 ? "fw-bold" : "text-muted")">
                                @q.ProcessingCount.ToString("N0")
                            </td>

                            <td class="align-middle text-end font-monospace @(q.SucceededCount > 0 ? "fw-bold" : "text-muted")">
                                @q.SucceededCount.ToString("N0")
                            </td>

                            <td class="align-middle text-end font-monospace @(q.FailedCount > 0 ? "fw-bold" : "text-muted")">
                                @q.FailedCount.ToString("N0")
                            </td>

                            <td class="align-middle text-end font-monospace @(q.CancelledCount > 0 ? "fw-bold" : "text-muted")">
                                @q.CancelledCount.ToString("N0")
                            </td>

                            <td class="align-middle text-end text-muted">
                                @if (q.LastJobAtUtc.HasValue)
                                {
                                    <span>@q.LastJobAtUtc.Value.ToLocalTime().ToString("HH:mm:ss")</span>
                                }
                                else
                                {
                                    <span>-</span>
                                }
                            </td>

                            <td class="pe-3 text-end align-middle">
                                @if (!isActive)
                                {
                                    <button class="btn btn-sm btn-link text-decoration-none text-muted p-0"
                                            title="Hide"
                                            @onclick="() => HideQueue(q.Name)">
                                        ✖
                                    </button>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        }
    </div>
</div>