@using ChokaQ.Abstractions
@using ChokaQ.Abstractions.DTOs
@using Microsoft.AspNetCore.SignalR.Client
@inject IJobStorage Storage

@if (_queues.Any())
{
    <div class="card cq-card shadow-sm mb-4">
        <div class="card-header py-2 d-flex justify-content-between align-items-center"
             style="background-color: var(--cq-panel-bg); border-bottom: 1px solid var(--cq-border);">
            <h6 class="mb-0 fw-bold small text-uppercase" style="color: var(--cq-text-muted)">
                🚦 Traffic Control (Queues)
            </h6>
        </div>
        <div class="card-body p-0">
            <table class="table mb-0" style="color: var(--cq-text);">
                <tbody>
                    @foreach (var q in _queues)
                    {
                        <tr style="border-bottom: 1px solid var(--cq-border);">
                            <td class="ps-3 align-middle">
                                <span class="fw-bold font-monospace">@q.Name</span>
                            </td>
                            <td class="align-middle">
                                <span class="badge" style="background-color: var(--cq-info); color: #000">@q.PendingCount Pending</span>
                                <span class="badge ms-1" style="background-color: var(--cq-warning); color: #000">@q.ProcessingCount Active</span>
                            </td>
                            <td class="pe-3 text-end align-middle">
                                <div class="form-check form-switch d-inline-block">
                                    <input class="form-check-input" type="checkbox"
                                           id="q_@q.Name"
                                           checked="@(!q.IsPaused)"
                                           @onchange="@(e => ToggleQueue(q.Name, (bool)e.Value!))">
                                    <label class="form-check-label small fw-bold ms-2 @(q.IsPaused ? "text-danger" : "text-success")" for="q_@q.Name">
                                        @(q.IsPaused ? "PAUSED 🛑" : "RUNNING 🟢")
                                    </label>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
}

@code {
    [Parameter] public HubConnection? HubConnection { get; set; }
    private List<QueueDto> _queues = new();
    private System.Threading.Timer? _timer;

    protected override void OnInitialized()
    {
        // Poll queue state every 2 seconds
        _timer = new System.Threading.Timer(async _ => await Refresh(), null, 0, 2000);
    }

    private async Task Refresh()
    {
        _queues = (await Storage.GetQueuesAsync()).ToList();
        await InvokeAsync(StateHasChanged);
    }

    private async Task ToggleQueue(string name, bool isRunning)
    {
        // UI Checkbox: Checked = Running, Unchecked = Paused
        // Logic: Paused = !Running
        var pause = !isRunning;

        // Optimistic update
        var q = _queues.FirstOrDefault(x => x.Name == name);
        if (q != null) q = q with { IsPaused = pause };

        if (HubConnection is not null)
        {
            await HubConnection.InvokeAsync("ToggleQueue", name, pause);
            await Refresh();
        }
    }

    public void Dispose() => _timer?.Dispose();
}