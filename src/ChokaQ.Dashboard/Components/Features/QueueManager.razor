<div class="card cq-card shadow-sm mb-4">
    <div class="card-header py-2 d-flex justify-content-between align-items-center"
         style="background-color: var(--cq-panel-bg); border-bottom: 1px solid var(--cq-border);">
        <div class="d-flex align-items-center gap-2">
            <h6 class="mb-0 fw-bold small text-uppercase" style="color: var(--cq-text-muted)">
                🚦 Queue Traffic & Performance
            </h6>
            @if (_queues.Any())
            {
                <span class="badge bg-secondary rounded-pill" style="font-size: 0.65rem;">@_visibleQueues.Count()</span>
            }
        </div>

        @if (_hiddenQueues.Any())
        {
            <button class="btn btn-sm btn-link text-decoration-none small p-0"
                    style="font-size: 0.75rem;"
                    @onclick="ShowAllQueues">
                Show Hidden (@_hiddenQueues.Count)
            </button>
        }
    </div>

    <div class="table-responsive">
        @if (!_queues.Any())
        {
            <div class="p-4 text-center text-muted small">
                @if (_isLoading)
                {
                    <span>⏳ Loading queues...</span>
                }
                else
                {
                    <span>No active queues found. Send a job to 'default' queue to see it here.</span>
                }
            </div>
        }
        else
        {
            <table class="table mb-0 text-nowrap" style="color: var(--cq-text); font-size: 0.85rem;">
                <thead style="background-color: rgba(0,0,0,0.02); font-size: 0.75rem; text-transform: uppercase;">
                    <tr>
                        <th class="ps-3">Queue Name</th>
                        <th class="text-center">Control</th>
                        <th class="text-center">Status</th>
                        <th class="text-end">Success</th>
                        <th class="text-end">Failed</th>
                        <th class="text-end">Duration</th>
                        <th class="text-end">Timeline</th>
                        <th class="text-end pe-3">Action</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var q in _visibleQueues)
                    {
                        // Active if Pending, Processing OR Fetched (Buffered)
                        var isActive = q.PendingCount > 0 || q.ProcessingCount > 0 || q.FetchedCount > 0;
                        var rowClass = isActive ? "" : "inactive-queue";

                        <tr class="@rowClass" style="border-bottom: 1px solid var(--cq-border); transition: background-color 0.3s;">
                            <td class="ps-3 align-middle">
                                <span class="fw-bold font-monospace fs-6">@q.Name</span>
                            </td>

                            <td class="align-middle text-center">
                                <div class="form-check form-switch d-inline-block" title="Pause/Resume Processing">
                                    <input class="form-check-input" type="checkbox"
                                           id="q_@q.Name"
                                           checked="@(!q.IsPaused)"
                                           @onchange="@(e => ToggleQueue(q.Name, (bool)e.Value!))">
                                </div>
                            </td>

                            <td class="align-middle text-center">
                                @if (q.IsPaused)
                                {
                                    <span class="badge bg-danger">PAUSED</span>
                                }
                                else if (q.ProcessingCount > 0)
                                {
                                    <span class="badge bg-warning text-dark">PROCESSING (@q.ProcessingCount)</span>
                                }
                                else if (q.FetchedCount > 0)
                                {
                                    <span class="badge" style="background-color: #6f42c1; color: white;">BUFFERED (@q.FetchedCount)</span>
                                }
                                else if (q.PendingCount > 0)
                                {
                                    <span class="badge bg-info text-dark">PENDING (@q.PendingCount)</span>
                                }
                                else
                                {
                                    <span class="badge bg-light text-dark border">IDLE</span>
                                }
                            </td>

                            <td class="align-middle text-end font-monospace text-success">
                                @(q.SucceededCount > 0 ? q.SucceededCount.ToString("N0") : "-")
                            </td>
                            <td class="align-middle text-end font-monospace text-danger">
                                @(q.FailedCount > 0 ? q.FailedCount.ToString("N0") : "-")
                            </td>

                            <td class="align-middle text-end font-monospace">
                                @GetDuration(q)
                            </td>

                            <td class="align-middle text-end small text-muted">
                                @if (q.FirstJobAtUtc.HasValue)
                                {
                                    <div>@q.FirstJobAtUtc.Value.ToLocalTime().ToString("HH:mm:ss")</div>
                                    @if (q.LastJobAtUtc.HasValue && q.LastJobAtUtc != q.FirstJobAtUtc)
                                    {
                                        <div>@q.LastJobAtUtc.Value.ToLocalTime().ToString("HH:mm:ss")</div>
                                    }
                                }
                                else
                                {
                                    <span>-</span>
                                }
                            </td>

                            <td class="pe-3 text-end align-middle">
                                @if (!isActive)
                                {
                                    <button class="btn btn-sm btn-link text-decoration-none text-muted p-0"
                                            title="Hide from Dashboard"
                                            @onclick="() => HideQueue(q.Name)">
                                        ✖
                                    </button>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        }
    </div>
</div>

<style>
    .inactive-queue {
        opacity: 0.5;
        background-color: rgba(128, 128, 128, 0.05);
        filter: grayscale(0.8);
    }

        .inactive-queue:hover {
            opacity: 1;
            filter: grayscale(0);
            background-color: var(--cq-panel-bg);
        }
</style>