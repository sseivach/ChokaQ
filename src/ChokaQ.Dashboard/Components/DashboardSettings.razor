@using ChokaQ.Core.Workers
@inject IWorkerManager WorkerManager

<div class="card bg-dark border-secondary shadow-sm mb-4">
    <div class="card-body d-flex align-items-center gap-4 flex-wrap">

        <div class="d-flex align-items-center gap-2">
            <div class="text-white fw-bold">⚙️ Workers:</div>
            <select class="form-select form-select-sm bg-dark text-white border-secondary"
                    style="width: 110px;"
                    @bind="DesiredWorkers">
                @for (int i = 1; i <= 10; i++)
                {
                    <option value="@i">@i Thread@(i > 1 ? "s" : "")</option>
                }
            </select>
            <span class="text-secondary small">
                (Active: <strong>@WorkerManager.ActiveWorkers</strong>)
            </span>
        </div>

        <div class="vr bg-secondary d-none d-md-block" style="height: 25px;"></div>

        <div class="d-flex align-items-center gap-2">
            <div class="text-white fw-bold">🔄 Max Retries:</div>
            <select class="form-select form-select-sm bg-dark text-white border-secondary"
                    style="width: 70px;"
                    @bind="MaxRetries">
                @for (int i = 1; i <= 10; i++)
                {
                    <option value="@i">@i</option>
                }
            </select>
        </div>

        <div class="vr bg-secondary d-none d-md-block" style="height: 25px;"></div>

        <div class="d-flex align-items-center gap-2">
            <div class="text-white fw-bold">⏱️ Delay (s):</div>
            <input type="number"
                   class="form-control form-control-sm bg-dark text-white border-secondary"
                   style="width: 80px;"
                   min="1"
                   max="3600"
                   @bind="RetryDelaySeconds" />
        </div>

        <div class="ms-auto">
            <button class="btn btn-sm btn-success px-4" @onclick="ApplyChanges">
                Apply Settings
            </button>
        </div>
    </div>
</div>

@code {
    // We use fields to hold local state before applying
    public int DesiredWorkers { get; set; }
    public int MaxRetries { get; set; }
    public int RetryDelaySeconds { get; set; }

    [Parameter] public EventCallback OnSettingsApplied { get; set; }

    protected override void OnInitialized()
    {
        // Hydrate from singleton
        DesiredWorkers = WorkerManager.ActiveWorkers;
        MaxRetries = WorkerManager.MaxRetries;
        RetryDelaySeconds = WorkerManager.RetryDelaySeconds;
    }

    private async Task ApplyChanges()
    {
        // Validation logic
        if (RetryDelaySeconds < 1) RetryDelaySeconds = 1;
        if (RetryDelaySeconds > 3600) RetryDelaySeconds = 3600;

        // Push to manager
        WorkerManager.UpdateWorkerCount(DesiredWorkers);
        WorkerManager.MaxRetries = MaxRetries;
        WorkerManager.RetryDelaySeconds = RetryDelaySeconds;

        // Notify parent (if needed)
        await OnSettingsApplied.InvokeAsync();
    }
}