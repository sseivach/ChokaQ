@using ChokaQ.Core.Workers
@inject IWorkerManager WorkerManager

<div class="card cq-card shadow-sm mb-4">
    <div class="card-body d-flex align-items-center gap-4 flex-wrap">

        <div class="d-flex align-items-center gap-2">
            <div class="fw-bold small">WORKERS</div>
            <select class="form-select form-select-sm cq-select" style="width: 100px;" @bind="DesiredWorkers">
                @for (int i = 1; i <= 10; i++)
                {
                    <option value="@i">@i</option>
                }
            </select>
        </div>

        <div class="d-flex align-items-center gap-2">
            <div class="fw-bold small">RETRIES</div>
            <select class="form-select form-select-sm cq-select" style="width: 60px;" @bind="MaxRetries">
                @for (int i = 1; i <= 10; i++)
                {
                    <option value="@i">@i</option>
                }
            </select>
        </div>

        <div class="d-flex align-items-center gap-2">
            <div class="fw-bold small">DELAY (S)</div>
            <input type="number" class="form-control form-control-sm cq-input" style="width: 70px;" min="1" max="3600" @bind="RetryDelaySeconds" />
        </div>

        <div class="vr" style="background-color: var(--cq-border); width: 1px; height: 24px;"></div>

        <div class="d-flex align-items-center gap-2">
            <div class="fw-bold small">THEME</div>
            <select class="form-select form-select-sm cq-select" style="width: 120px;"
                    value="@CurrentTheme"
                    @onchange="OnThemeChange">
                <option value="dark">Dark (Default)</option>
                <option value="light">Light</option>
                <option value="blue">Corporate Blue</option>
                <option value="green">Terminal Green</option>
            </select>
        </div>

        <div class="ms-auto">
            <button class="btn btn-sm btn-outline-success px-4" @onclick="ApplyChanges">
                Apply
            </button>
        </div>
    </div>
</div>

@code {
    public int DesiredWorkers { get; set; }
    public int MaxRetries { get; set; }
    public int RetryDelaySeconds { get; set; }

    [Parameter] public string CurrentTheme { get; set; } = "dark";
    [Parameter] public EventCallback OnSettingsApplied { get; set; }
    [Parameter] public EventCallback<string> OnThemeChanged { get; set; }

    protected override void OnInitialized()
    {
        DesiredWorkers = WorkerManager.ActiveWorkers;
        MaxRetries = WorkerManager.MaxRetries;
        RetryDelaySeconds = WorkerManager.RetryDelaySeconds;
    }

    private async Task ApplyChanges()
    {
        if (RetryDelaySeconds < 1) RetryDelaySeconds = 1;
        WorkerManager.UpdateWorkerCount(DesiredWorkers);
        WorkerManager.MaxRetries = MaxRetries;
        WorkerManager.RetryDelaySeconds = RetryDelaySeconds;
        await OnSettingsApplied.InvokeAsync();
    }

    private async Task OnThemeChange(ChangeEventArgs e)
    {
        await OnThemeChanged.InvokeAsync(e.Value?.ToString() ?? "dark");
    }
}