@using ChokaQ.Dashboard.Models
@using Microsoft.AspNetCore.SignalR.Client

<div class="card cq-card shadow-sm">
    <div class="card-header py-3 d-flex justify-content-between align-items-center"
         style="background-color: var(--cq-panel-bg); border-bottom: 1px solid var(--cq-border);">
        <h5 class="mb-0 fw-bold">Live Feed</h5>
        <div class="d-flex gap-3 align-items-center">
            @if (IsConnected)
            {
                <span class="small fw-bold" style="color: var(--cq-success)">ONLINE</span>
            }
            else
            {
                <span class="small fw-bold" style="color: var(--cq-danger)">OFFLINE</span>
            }

            <button class="btn btn-sm btn-outline-secondary" @onclick="OnClearHistory">
                Clear
            </button>
        </div>
    </div>

    <div class="table-responsive">
        <table class="cq-table">
            <thead>
                <tr>
                    <th style="width: 25%">ID</th>
                    <th style="width: 15%">Status</th>
                    <th style="width: 25%">Progress</th>
                    <th style="width: 10%">Att.</th>
                    <th style="width: 15%">Duration</th>
                    <th class="text-end">Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var job in Jobs)
                {
                    <JobRow @key="job.Id" Job="job" OnCancelRequested="HandleCancelRequest" />
                }

                @if (!Jobs.Any())
                {
                    <tr>
                        <td colspan="6" class="text-center py-5" style="color: var(--cq-text-muted)">
                            No active jobs
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

@code {
    [Parameter] public IEnumerable<JobViewModel> Jobs { get; set; } = Enumerable.Empty<JobViewModel>();
    [Parameter] public bool IsConnected { get; set; }
    [Parameter] public EventCallback OnClearHistory { get; set; }

    // Receive Hub Connection to send commands
    [Parameter] public HubConnection? HubConnection { get; set; }

    private async Task HandleCancelRequest(string jobId)
    {
        if (HubConnection is not null && IsConnected)
        {
            // Call the server-side Hub method "CancelJob"
            await HubConnection.InvokeAsync("CancelJob", jobId);
        }
    }
}