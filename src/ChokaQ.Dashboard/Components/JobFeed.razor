@using ChokaQ.Dashboard.Models
@using ChokaQ.Abstractions.Enums
@using Microsoft.AspNetCore.SignalR.Client
@using ChokaQ.Dashboard.Components
@using Microsoft.AspNetCore.Components.Web.Virtualization

<div class="card cq-card shadow-sm h-100 d-flex flex-column">
    <div class="card-header py-2 d-flex justify-content-between align-items-center"
         style="background-color: var(--cq-panel-bg); border-bottom: 1px solid var(--cq-border);">

        <ul class="nav nav-pills card-header-pills">
            <li class="nav-item">
                <button class="nav-link btn-sm @(_activeTab == "all" ? "active" : "")"
                        @onclick="@(() => SetTab("all"))">
                    All
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link btn-sm @(_activeTab == "processing" ? "active" : "")"
                        @onclick="@(() => SetTab("processing"))">
                    Processing
                    @if (GetCount(JobStatus.Processing) > 0)
                    {
                        <span class="badge bg-warning text-dark ms-1">@GetCount(JobStatus.Processing)</span>
                    }
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link btn-sm @(_activeTab == "failed" ? "active" : "")"
                        @onclick="@(() => SetTab("failed"))">
                    Failed
                    @if (GetCount(JobStatus.Failed) > 0)
                    {
                        <span class="badge bg-danger ms-1">@GetCount(JobStatus.Failed)</span>
                    }
                </button>
            </li>
        </ul>

        <div class="d-flex gap-3 align-items-center">
            @if (IsConnected)
            {
                <span class="small fw-bold" style="color: var(--cq-success)">ONLINE</span>
            }
            else
            {
                <span class="small fw-bold" style="color: var(--cq-danger)">OFFLINE</span>
            }

            <button class="btn btn-sm btn-outline-secondary" @onclick="OnClearHistory">
                Clear
            </button>
        </div>
    </div>

    <div class="table-responsive flex-grow-1" style="min-height: 400px; height: 600px; overflow-y: auto;">
        <table class="cq-table">
            <thead style="position: sticky; top: 0; background-color: var(--cq-panel-bg); z-index: 10;">
                <tr>
                    <th style="width: 20%">ID</th>
                    <th style="width: 15%">Type</th>
                    <th style="width: 10%">Status</th>
                    <th style="width: 25%">Progress</th>
                    <th style="width: 5%">Att.</th>
                    <th style="width: 10%">Duration</th>
                    <th class="text-end">Actions</th>
                </tr>
            </thead>
            <tbody>

                @* VIRTUALIZATION MAGIC 
                   OverscanCount=10 renders 10 extra items outside view to prevent white flickering on fast scroll.
                   ItemSize=50 is an estimate row height in pixels to help calculator.
                *@
                <Virtualize Items="@FilteredJobs" Context="job" OverscanCount="10" ItemSize="55">
                    <ItemContent>
                        <JobRow @key="job.Id"
                                Job="job"
                                OnCancelRequested="HandleCancelRequest"
                                OnRestartRequested="HandleRestartRequest"
                                OnSelected="OpenInspector" />
                    </ItemContent>
                    <Placeholder>
                        <tr>
                            <td colspan="7" class="text-center py-2 text-muted">Loading item...</td>
                        </tr>
                    </Placeholder>
                    <EmptyContent>
                        <tr>
                            <td colspan="7" class="text-center py-5" style="color: var(--cq-text-muted)">
                                No jobs found in this filter.
                            </td>
                        </tr>
                    </EmptyContent>
                </Virtualize>

            </tbody>
        </table>
    </div>
</div>

<JobInspector @bind-IsVisible="_isInspectorVisible"
              JobId="@_selectedJobId"
              OnRestart="HandleRestartRequest"
              OnDelete="HandleDeleteRequest" />

@code {
    [Parameter] public List<JobViewModel> Jobs { get; set; } = new();
    [Parameter] public bool IsConnected { get; set; }
    [Parameter] public EventCallback OnClearHistory { get; set; }
    [Parameter] public HubConnection? HubConnection { get; set; }

    private bool _isInspectorVisible;
    private string? _selectedJobId;
    private string _activeTab = "all";

    // Computed property for the Virtualizer
    // We strictly filter here.
    private ICollection<JobViewModel> FilteredJobs
    {
        get
        {
            // Stable Sort: Always by AddedAt Descending to prevent jumping rows
            // We use the reference to the main list.
            var baseQuery = Jobs;

            if (_activeTab == "processing")
                return baseQuery.Where(x => x.Status == JobStatus.Processing || x.Status == JobStatus.Pending).ToList();

            if (_activeTab == "failed")
                return baseQuery.Where(x => x.Status == JobStatus.Failed || x.Status == JobStatus.Cancelled).ToList();

            return baseQuery;
        }
    }

    private int GetCount(JobStatus status) => Jobs.Count(x => x.Status == status);

    private void SetTab(string tab)
    {
        _activeTab = tab;
        // No need for StateHasChanged, generic binding handles it or parent updates
    }

    private async Task HandleCancelRequest(string jobId)
    {
        if (HubConnection is not null && IsConnected)
        {
            await HubConnection.InvokeAsync("CancelJob", jobId);
        }
    }

    private async Task HandleRestartRequest(string jobId)
    {
        if (HubConnection is not null && IsConnected)
        {
            await HubConnection.InvokeAsync("RestartJob", jobId);
        }
    }

    private void OpenInspector(string jobId)
    {
        _selectedJobId = jobId;
        _isInspectorVisible = true;
    }

    private Task HandleDeleteRequest(string jobId)
    {
        _isInspectorVisible = false;
        return Task.CompletedTask;
    }
}