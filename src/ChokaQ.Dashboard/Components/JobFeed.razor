@using ChokaQ.Dashboard.Models
@using Microsoft.AspNetCore.SignalR.Client
@using ChokaQ.Dashboard.Components

<div class="card cq-card shadow-sm">
    <div class="card-header py-3 d-flex justify-content-between align-items-center"
         style="background-color: var(--cq-panel-bg); border-bottom: 1px solid var(--cq-border);">
        <h5 class="mb-0 fw-bold">Live Feed</h5>

        <div class="d-flex gap-3 align-items-center">
            @if (IsConnected)
            {
                <span class="small fw-bold" style="color: var(--cq-success)">ONLINE</span>
            }
            else
            {
                <span class="small fw-bold" style="color: var(--cq-danger)">OFFLINE</span>
            }

            <button class="btn btn-sm btn-outline-secondary" @onclick="OnClearHistory">
                Clear
            </button>
        </div>
    </div>

    <div class="table-responsive">
        <table class="cq-table">
            <thead>
                <tr>
                    <th style="width: 20%">ID</th>
                    <th style="width: 15%">Type</th>
                    <th style="width: 10%">Status</th>
                    <th style="width: 25%">Progress</th>
                    <th style="width: 5%">Att.</th>
                    <th style="width: 10%">Duration</th>
                    <th class="text-end">Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var job in Jobs)
                {
                    <JobRow @key="job.Id"
                            Job="job"
                            OnCancelRequested="HandleCancelRequest"
                            OnRestartRequested="HandleRestartRequest"
                            OnSelected="OpenInspector" />
                }

                @if (!Jobs.Any())
                {
                    <tr>
                        <td colspan="7" class="text-center py-5" style="color: var(--cq-text-muted)">
                            No active jobs
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

<JobInspector @bind-IsVisible="_isInspectorVisible"
              JobId="@_selectedJobId"
              OnRestart="HandleRestartRequest"
              OnDelete="HandleDeleteRequest" />

@code {
    [Parameter] public IEnumerable<JobViewModel> Jobs { get; set; } = Enumerable.Empty<JobViewModel>();
    [Parameter] public bool IsConnected { get; set; }
    [Parameter] public EventCallback OnClearHistory { get; set; }

    // Receive Hub Connection to send commands
    [Parameter] public HubConnection? HubConnection { get; set; }

    // Inspector State
    private bool _isInspectorVisible;
    private string? _selectedJobId;

    private async Task HandleCancelRequest(string jobId)
    {
        if (HubConnection is not null && IsConnected)
        {
            await HubConnection.InvokeAsync("CancelJob", jobId);
        }
    }

    private async Task HandleRestartRequest(string jobId)
    {
        if (HubConnection is not null && IsConnected)
        {
            await HubConnection.InvokeAsync("RestartJob", jobId);
            // Optionally close inspector after action
            // _isInspectorVisible = false;
        }
    }

    private void OpenInspector(string jobId)
    {
        _selectedJobId = jobId;
        _isInspectorVisible = true;
    }

    private Task HandleDeleteRequest(string jobId)
    {
        // TODO: Implement delete logic in Hub and Worker
        _isInspectorVisible = false;
        return Task.CompletedTask;
    }
}