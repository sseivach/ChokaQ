@using Microsoft.AspNetCore.SignalR.Client
@using ChokaQ.Abstractions.Enums
@implements IAsyncDisposable
@inject NavigationManager Navigation

<div class="p-4 rounded shadow-lg border border-secondary" style="background-color: #1e1e1e;">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h4 class="text-white mb-0">🔌 ChokaQ Dashboard Component</h4>
        <small class="text-secondary">v1.0.0</small>
    </div>

    <div class="row mb-4 g-3">
        <div class="col-md-3">
            <div class="card bg-dark text-white border-secondary shadow-sm">
                <div class="card-body">
                    <h6 class="text-secondary text-uppercase mb-2">Processing</h6>
                    <h2 class="mb-0 text-warning">
                        @jobs.Count(x => x.Status == JobStatus.Processing)
                        <span class="fs-6">⚡</span>
                    </h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-dark text-white border-secondary shadow-sm">
                <div class="card-body">
                    <h6 class="text-secondary text-uppercase mb-2">Succeeded</h6>
                    <h2 class="mb-0 text-success">
                        @jobs.Count(x => x.Status == JobStatus.Succeeded)
                        <span class="fs-6">✅</span>
                    </h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-dark text-white border-secondary shadow-sm">
                <div class="card-body">
                    <h6 class="text-secondary text-uppercase mb-2">Failed</h6>
                    <h2 class="mb-0 text-danger">
                        @jobs.Count(x => x.Status == JobStatus.Failed)
                        <span class="fs-6">🔥</span>
                    </h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-dark text-white border-secondary shadow-sm">
                <div class="card-body">
                    <h6 class="text-secondary text-uppercase mb-2">Total Jobs</h6>
                    <h2 class="mb-0 text-primary">@jobs.Count</h2>
                </div>
            </div>
        </div>
    </div>

    <div class="card bg-dark border-secondary shadow-sm">
        <div class="card-header bg-dark border-secondary py-3 d-flex justify-content-between align-items-center">
            <h5 class="mb-0 fw-bold text-white">🚀 Live Job Feed</h5>

            <div class="d-flex gap-2 align-items-center">
                @if (isConnected)
                {
                    <span class="badge bg-success text-white border border-success px-3">
                        ● Online
                    </span>
                }
                else
                {
                    <span class="badge bg-danger text-white border border-danger px-3">
                        ● Offline
                    </span>
                }

                <button class="btn btn-sm btn-outline-secondary" @onclick="ClearHistory">
                    🗑️ Clear
                </button>
            </div>
        </div>

        <div class="table-responsive">
            <table class="table table-dark table-hover align-middle mb-0">
                <thead>
                    <tr class="text-secondary">
                        <th scope="col" style="width: 40%">Job ID</th>
                        <th scope="col">Status</th>
                        <th scope="col">Last Update</th>
                        <th scope="col" class="text-end">Action</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var job in jobs)
                    {
                        <tr @key="job.Id" class="@getRowClass(job)">
                            <td>
                                <code class="text-info fw-bold">@job.Id</code>
                            </td>
                            <td>
                                <span class="badge rounded-pill @GetBadgeClass(job.Status)">
                                    @GetStatusIcon(job.Status) @job.Status
                                </span>
                            </td>
                            <td class="text-secondary small">
                                @job.LastUpdated.ToString("HH:mm:ss.fff")
                            </td>
                            <td class="text-end">
                                <button class="btn btn-link btn-sm text-secondary text-decoration-none p-0">
                                    Details ➝
                                </button>
                            </td>
                        </tr>
                    }
                    @if (!jobs.Any())
                    {
                        <tr>
                            <td colspan="4" class="text-center py-5 text-muted">
                                <div class="fs-1 mb-2">💤</div>
                                <p>No active jobs in queue</p>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

@code {
    private HubConnection? hubConnection;
    private List<JobViewModel> jobs = new();
    private bool isConnected => hubConnection?.State == HubConnectionState.Connected;

    protected override async Task OnInitializedAsync()
    {
        hubConnection = new HubConnectionBuilder()
            .WithUrl(Navigation.ToAbsoluteUri("/chokaq-hub"))
            .WithAutomaticReconnect()
            .Build();

        hubConnection.On<string, int>("JobUpdated", (jobId, statusInt) =>
        {
            var status = (JobStatus)statusInt;
            UpdateJob(jobId, status);
            InvokeAsync(StateHasChanged);
        });

        await hubConnection.StartAsync();
    }

    private void UpdateJob(string jobId, JobStatus status)
    {
        var existing = jobs.FirstOrDefault(j => j.Id == jobId);
        if (existing != null)
        {
            existing.Status = status;
            existing.LastUpdated = DateTime.Now;
        }
        else
        {
            jobs.Insert(0, new JobViewModel { Id = jobId, Status = status, LastUpdated = DateTime.Now });
            if (jobs.Count > 100) jobs.RemoveAt(jobs.Count - 1);
        }
    }

    private void ClearHistory()
    {
        jobs.Clear();
    }

    private string GetBadgeClass(JobStatus status) => status switch
    {
        JobStatus.Pending => "bg-secondary text-white",
        JobStatus.Processing => "bg-warning text-dark",
        JobStatus.Succeeded => "bg-success text-white",
        JobStatus.Failed => "bg-danger text-white",
        _ => "bg-light text-dark"
    };

    private string GetStatusIcon(JobStatus status) => status switch
    {
        JobStatus.Pending => "⏳",
        JobStatus.Processing => "⚙️",
        JobStatus.Succeeded => "✅",
        JobStatus.Failed => "❌",
        _ => "❓"
    };

    private string getRowClass(JobViewModel job)
    {
        // Подсветка строки в темной теме должна быть аккуратной
        return job.Status == JobStatus.Processing ? "table-active" : "";
    }

    public async ValueTask DisposeAsync()
    {
        if (hubConnection is not null)
        {
            await hubConnection.DisposeAsync();
        }
    }

    public class JobViewModel
    {
        public string Id { get; set; } = "";
        public JobStatus Status { get; set; }
        public DateTime LastUpdated { get; set; }
    }
}