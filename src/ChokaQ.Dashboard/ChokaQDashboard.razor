@using ChokaQ.Abstractions.Enums
@* Logic is in ChokaQDashboard.razor.cs *@

<div class="p-4 rounded shadow-lg border border-secondary" style="background-color: #1e1e1e;">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h4 class="text-white mb-0">🔌 ChokaQ Dashboard Component</h4>
        <small class="text-secondary">v1.0.0</small>
    </div>

    <div class="row mb-4 g-3">
        <div class="col-md-3">
            <div class="card bg-dark text-white border-secondary shadow-sm">
                <div class="card-body">
                    <h6 class="text-secondary text-uppercase mb-2">Processing</h6>
                    <h2 class="mb-0 text-warning">
                        @_jobs.Count(x => x.Status == JobStatus.Processing)
                        <span class="fs-6">⚡</span>
                    </h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-dark text-white border-secondary shadow-sm">
                <div class="card-body">
                    <h6 class="text-secondary text-uppercase mb-2">Succeeded</h6>
                    <h2 class="mb-0 text-success">
                        @_jobs.Count(x => x.Status == JobStatus.Succeeded)
                        <span class="fs-6">✅</span>
                    </h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-dark text-white border-secondary shadow-sm">
                <div class="card-body">
                    <h6 class="text-secondary text-uppercase mb-2">Failed</h6>
                    <h2 class="mb-0 text-danger">
                        @_jobs.Count(x => x.Status == JobStatus.Failed)
                        <span class="fs-6">🔥</span>
                    </h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-dark text-white border-secondary shadow-sm">
                <div class="card-body">
                    <h6 class="text-secondary text-uppercase mb-2">Total Jobs</h6>
                    <h2 class="mb-0 text-primary">@_jobs.Count</h2>
                </div>
            </div>
        </div>
    </div>

    <div class="card bg-dark border-secondary shadow-sm mb-4">
        <div class="card-body d-flex align-items-center gap-4 flex-wrap">

            <div class="d-flex align-items-center gap-2">
                <div class="text-white fw-bold">⚙️ Workers:</div>
                <select class="form-select form-select-sm bg-dark text-white border-secondary"
                        style="width: 110px;"
                        @bind="_desiredWorkers">
                    @for (int i = 1; i <= 10; i++)
                    {
                        <option value="@i">@i Thread@(i > 1 ? "s" : "")</option>
                    }
                </select>
                <span class="text-secondary small">
                    (Active: <strong>@WorkerManager.ActiveWorkers</strong>)
                </span>
            </div>

            <div class="vr bg-secondary d-none d-md-block" style="height: 25px;"></div>

            <div class="d-flex align-items-center gap-2">
                <div class="text-white fw-bold">🔄 Max Retries:</div>
                <select class="form-select form-select-sm bg-dark text-white border-secondary"
                        style="width: 70px;"
                        @bind="_maxRetries">
                    @for (int i = 1; i <= 10; i++)
                    {
                        <option value="@i">@i</option>
                    }
                </select>
            </div>

            <div class="vr bg-secondary d-none d-md-block" style="height: 25px;"></div>

            <div class="d-flex align-items-center gap-2">
                <div class="text-white fw-bold">⏱️ Delay (s):</div>
                <input type="number"
                       class="form-control form-control-sm bg-dark text-white border-secondary"
                       style="width: 80px;"
                       min="1"
                       max="3600"
                       @bind="_retryDelaySeconds" />
            </div>

            <div class="ms-auto">
                <button class="btn btn-sm btn-success px-4" @onclick="UpdateSettings">
                    Apply Settings
                </button>
            </div>
        </div>
    </div>

    <div class="card bg-dark border-secondary shadow-sm">
        <div class="card-header bg-dark border-secondary py-3 d-flex justify-content-between align-items-center">
            <h5 class="mb-0 fw-bold text-white">🚀 Live Job Feed</h5>

            <div class="d-flex gap-2 align-items-center">
                @if (IsConnected)
                {
                    <span class="badge bg-success text-white border border-success px-3">
                        ● Online
                    </span>
                }
                else
                {
                    <span class="badge bg-danger text-white border border-danger px-3">
                        ● Offline
                    </span>
                }

                <button class="btn btn-sm btn-outline-secondary" @onclick="ClearHistory">
                    🗑️ Clear
                </button>
            </div>
        </div>

        <div class="table-responsive">
            <table class="table table-dark table-hover align-middle mb-0" id="table-feed">
                <thead>
                    <tr class="text-secondary">
                        <th scope="col" style="width: 30%">Job ID</th>
                        <th scope="col">Status</th>
                        <th scope="col" style="width: 20%">Progress</th>
                        <th scope="col">Attempts</th>
                        <th scope="col">Duration</th>
                        <th scope="col" class="text-end">Action</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var job in _jobs)
                    {
                        <tr @key="job.Id" class="@GetRowClass(job)">
                            <td>
                                <code class="text-info fw-bold">@job.Id</code>
                            </td>
                            <td>
                                <span class="badge rounded-pill @GetBadgeClass(job.Status)">
                                    @GetStatusIcon(job.Status) @job.Status
                                </span>
                            </td>
                            <td>
                                @if (job.Status == JobStatus.Processing)
                                {
                                    <div class="progress" style="height: 6px; background-color: #333;">
                                        <div class="progress-bar bg-warning"
                                             role="progressbar"
                                             style="width: @(job.Progress)%; transition: width 0.3s ease;">
                                        </div>
                                    </div>
                                    <div class="text-end text-muted mt-1" style="font-size: 0.7em;">@job.Progress%</div>
                                }
                                else if (job.Status == JobStatus.Succeeded)
                                {
                                    <div class="progress" style="height: 6px;">
                                        <div class="progress-bar bg-success" style="width: 100%"></div>
                                    </div>
                                }
                                else
                                {
                                    <span class="text-muted small">-</span>
                                }
                            </td>
                            <td>
                                @if (job.Attempts > 0)
                                {
                                    <span class="badge bg-dark border border-secondary text-secondary">
                                        @job.Attempts
                                    </span>
                                }
                                else
                                {
                                    <span class="text-muted small">-</span>
                                }
                            </td>
                            <td class="text-white font-monospace small">
                                @FormatDuration(job.Duration)
                            </td>
                            <td class="text-end">
                                <button class="btn btn-link btn-sm text-secondary text-decoration-none p-0">
                                    Details ➝
                                </button>
                            </td>
                        </tr>
                    }
                    @if (!_jobs.Any())
                    {
                        <tr>
                            <td colspan="6" class="text-center py-5 text-muted">
                                <div class="fs-1 mb-2">💤</div>
                                <p>No active jobs in queue</p>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>