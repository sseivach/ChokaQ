@using ChokaQ.Abstractions.Entities
@namespace ChokaQ.TheDeck.UI.Components.Queues
@implements IDisposable

<section class="queues">
    @if (_isLoading)
    {
        <div class="queues__loading">
            <span>Loading queues...</span>
        </div>
    }
    else if (!VisibleQueues.Any() && !_showInactive)
    {
        <div class="queues__empty">
            <span>No active queues found. Send a job to 'default' queue to see it here.</span>
            <br />
            <label class="queues__show-hidden-label-container">
                <input type="checkbox" @bind="_showInactive" /> Show Hidden Queues
            </label>
        </div>
    }
    else
    {
        <table class="deck-table queues__table">
            <thead>
                <tr>
                    <th class="queues__th queues__th--name">
                        Queue
                    </th>
                    <th class="queues__th queues__th--stats">Succeeded</th>
                    <th class="queues__th queues__th--reserv2">Failed</th>
                    <th class="queues__th queues__th--reserv1">Buffered</th>
                    <th class="queues__th queues__th--reserv3">Pending</th>
                    <th class="queues__th queues__th--timeout">Max Workers</th>
                    <th class="queues__th queues__th--timeout">Zombie (s)</th>
                    <th class="queues__th queues__th--updated">Last Updated</th>
                    <th class="queues__th queues__th--status">Status</th>
                    <th class="queues__th queues__th--toggle">Pause / Resume</th>
                    <th class="queues__th queues__th--actions">
                        <label class="queues__show-hidden-label">
                            <input type="checkbox" @bind="_showInactive" /> SHOW HIDDEN
                        </label>
                    </th>
                </tr>
            </thead>
            <tbody>
                @foreach (var q in VisibleQueues)
                {
                    var stats = GetQueueStats(q.Name);
                    <tr>
                        <td class="queues__name @(!q.IsActive ? "queues__name--inactive" : "")">@q.Name</td>

                        <td class="queues__stats">
                            @if (stats != null)
                            {
                                <span class="queues__stats-succeeded">@stats.SucceededTotal.ToString("N0")</span>
                            }
                            else
                            {
                                <span class="queues__stats-empty">0</span>
                            }
                        </td>

                        <td class="queues__reserv2-cell">
                            @if (stats != null)
                            {
                                <span class="queues__stats-failed">@stats.FailedTotal.ToString("N0")</span>
                            }
                            else
                            {
                                <span class="queues__stats-empty">0</span>
                            }
                        </td>

                        <td class="queues__stats">
                            @if (stats != null)
                            {
                                <span class="queues__stats-buffered" title="Buffered (Fetched)">@stats.Fetched.ToString("N0")</span>
                            }
                            else
                            {
                                <span class="queues__stats-empty">-</span>
                            }
                        </td>

                        <td class="queues__reserv3-cell">
                            @if (stats != null)
                            {
                                <span class="queues__stats-pending" title="Pending">@stats.Pending.ToString("N0")</span>
                            }
                            else
                            {
                                <span class="queues__stats-empty">-</span>
                            }
                        </td>

                        <td class="queues__timeout-cell">
                            <input type="number"
                                   class="queues__timeout-input"
                                   value="@q.MaxWorkers"
                                   placeholder="?"
                                   min="1"
                                   @onchange="@(e => UpdateMaxWorkers(q.Name, e.Value))" />
                        </td>

                        <td class="queues__timeout-cell">
                            <input type="number"
                                   class="queues__timeout-input"
                                   value="@q.ZombieTimeoutSeconds"
                                   @onchange="@(e => UpdateTimeout(q.Name, e.Value))" />
                        </td>

                        <td class="queues__updated">
                            @q.LastUpdatedUtc.ToLocalTime().ToString("HH:mm:ss")
                        </td>

                        <td class="queues__status-cell">
                            <span class="queues__status @GetStatusModifier(q)">
                                @GetQueueStatus(q)
                            </span>
                        </td>

                        <td class="queues__toggle-cell">
                            <label class="deck-switch" title="@(!q.IsActive ? "Restore queue to resume processing" : "")">
                                <input type="checkbox"
                                       checked="@(!q.IsPaused)"
                                       disabled="@(!q.IsActive)"
                                       @onchange="@(e => ToggleQueue(q.Name, (bool)e.Value!))" />
                                <span class="deck-switch__slider"></span>
                            </label>
                        </td>

                        <td class="queues__actions">
                            @if (q.IsActive)
                            {
                                <button class="deck-btn queues__action-btn"
                                        title="Hide queue (Deactivate)"
                                        @onclick="() => DeactivateQueue(q.Name)">
                                    HIDE
                                </button>
                            }
                            else
                            {
                                <button class="deck-btn queues__action-btn deck-btn-primary"
                                        title="Restore queue"
                                        @onclick="() => ActivateQueue(q.Name)">
                                    UNHIDE
                                </button>
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }
</section>