@using Microsoft.AspNetCore.Components.Web.Virtualization
@using ChokaQ.TheDeck.Models
@using ChokaQ.Abstractions.Enums
@using ChokaQ.TheDeck.UI.Components.JobMatrix.JobRow
@namespace ChokaQ.TheDeck.UI.Components.JobMatrix

<section class="matrix">
    <!-- Toolbar -->
    <header class="matrix__toolbar">
        <div class="matrix__search-container">
             <div class="matrix__search-box">
                 <span class="matrix__search-label">SEARCH</span>
                 <input type="text"
                        class="matrix__search-input"
                        placeholder="ID, Type, Queue..."
                        @bind="_searchQuery"
                        @bind:event="oninput" />
                 @if (!string.IsNullOrEmpty(_searchQuery))
                 {
                     <span class="matrix__search-count">@FilteredJobs.Count</span>
                     <button class="matrix__search-clear" @onclick="() => _searchQuery = string.Empty">X</button>
                 }
             </div>
        </div>

        <!-- Date Filters (New Row) -->
        <div class="matrix__toolbar-row matrix__toolbar-row--filters">
            <span class="matrix__filter-label">FROM</span>
            <input type="date" class="matrix__date-input" @bind="_dateFrom" />
            <span class="matrix__filter-label">TO</span>
            <input type="date" class="matrix__date-input" @bind="_dateTo" />
            <button class="deck-btn deck-btn-primary" @onclick="LoadHistory">Load History</button>
        </div>

        <!-- Bulk Actions (Now inside toolbar) -->
        @if (SelectedCount > 0)
        {
            <div class="matrix__bulk-actions">
                <span class="deck-badge matrix__selection-badge">@SelectedCount selected</span>
                <button class="deck-btn deck-btn-primary" @onclick="RestartSelected">Retry All</button>
                <button class="deck-btn deck-btn-danger" @onclick="CancelSelected">Cancel All</button>
                
                <div class="matrix__bulk-priority">
                    <span class="matrix__bulk-label">PRIORITY:</span>
                    <input type="number" class="matrix__bulk-input" @bind="_bulkPriorityValue" />
                    <button class="deck-btn deck-btn-primary" @onclick="SetPrioritySelected">Apply</button>
                </div>
            </div>
        }
        
        <div class="matrix__controls">
             <button class="deck-btn" @onclick="OnClearHistory">Clear History</button>
        </div>
    </header>

    <!-- Table -->
    <div class="matrix__table-container">
        <table class="deck-table matrix__table">
            <thead>
                <tr>
                    <th class="matrix__th matrix__th--checkbox">
                        <div class="matrix__header-checks">
                            <input type="checkbox" class="matrix__checkbox-all" checked="@IsAllVisibleSelected" @onchange="ToggleSelectAll" title="Select Visible" />
                            @if (SelectedCount > 0)
                            {
                                <button class="matrix__deselect-all" @onclick="ClearSelection" title="Deselect All"></button>
                            }
                        </div>
                    </th>
                    <th class="matrix__th matrix__th--id">ID</th>
                    <th class="matrix__th matrix__th--queue">Queue</th>
                    <th class="matrix__th matrix__th--type">Type</th>
                    <th class="matrix__th matrix__th--priority">Priority</th>
                    <th class="matrix__th matrix__th--user">User</th>
                    <th class="matrix__th matrix__th--status">Status</th>
                    <th class="matrix__th matrix__th--progress">Progress</th>
                    <th class="matrix__th matrix__th--attempts">Try</th>
                    <th class="matrix__th matrix__th--duration">Duration</th>
                    <th class="matrix__th matrix__th--actions">Actions</th>
                </tr>
            </thead>
            <tbody>
                <Virtualize Items="@FilteredJobs" Context="job" OverscanCount="10" ItemSize="45">
                    <ItemContent>
                        <JobRow @key="job.Id"
                                Job="job"
                                IsSelected="@_selectedJobIds.Contains(job.Id)"
                                OnSelectionChanged="@(isSelected => ToggleSelection(job.Id, isSelected))"
                                OnCancelRequested="HandleCancelRequest"
                                OnRestartRequested="HandleRestartRequest"
                                OnSelected="HandleJobSelected" />
                    </ItemContent>
                    <Placeholder>
                         <tr><td colspan="11" class="matrix__loading">Loading...</td></tr>
                    </Placeholder>
                    <EmptyContent>
                         <tr><td colspan="11" class="matrix__empty">No jobs found.</td></tr>
                    </EmptyContent>
                </Virtualize>
            </tbody>
        </table>
    </div>
</section>
