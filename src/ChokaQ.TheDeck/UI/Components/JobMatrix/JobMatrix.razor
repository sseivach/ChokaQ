@using Microsoft.AspNetCore.Components.Web.Virtualization
@using ChokaQ.TheDeck.Models
@using ChokaQ.Abstractions.Enums
@using ChokaQ.TheDeck.UI.Components.JobMatrix.JobRow
@namespace ChokaQ.TheDeck.UI.Components.JobMatrix

<section class="matrix">
    <header class="matrix__toolbar">
        <div class="matrix__toolbar-col matrix__toolbar-col--left">
            <div class="matrix__search-container">
            @if (!IsHistoryMode)
            {
                <div class="matrix__search-box">
                    <span class="matrix__search-label">SEARCH</span>
                    <input type="text"
                           class="matrix__search-input"
                           placeholder=""
                           @bind="_searchQuery"
                           @bind:event="oninput" />
                    @if (!string.IsNullOrEmpty(_searchQuery))
                    {
                        <span class="matrix__search-count">@FilteredJobs.Count</span>
                        <button class="matrix__search-clear" @onclick="() => _searchQuery = string.Empty">✕</button>
                    }
                </div>
            }
            else
            {
                <div class="matrix__search-placeholder">
                    <span>← Use Filters in OpsPanel</span>
                </div>
            }
            </div>
        </div>

        <!-- Column 2: Bulk Actions (Center Aligned) -->
        <div class="matrix__toolbar-col matrix__toolbar-col--center">
            @if (SelectedCount > 0)
            {
                <div class="matrix__bulk-actions">
                    <span class="deck-badge matrix__selection-badge">@SelectedCount selected</span>
                    <button class="deck-btn deck-btn-primary" @onclick="RestartSelected">Retry</button>
                    <button class="deck-btn deck-btn-danger" @onclick="CancelSelected">Cancel</button>
                </div>
            }
        </div>

        <!-- Column 3: Mode Toggle (Right Aligned) -->
        <div class="matrix__toolbar-col matrix__toolbar-col--right">
            <div class="matrix__mode-toggle">
                <button class="deck-btn @(!IsHistoryMode ? "deck-btn-live" : "")"
                        @onclick="() => ToggleMode(false)"
                        title="Real-time updates">
                    LIVE
                </button>
                <button class="deck-btn @(IsHistoryMode ? "deck-btn-history" : "")"
                        @onclick="() => ToggleMode(true)"
                        title="Historical data & Analysis">
                    HISTORY
                </button>
            </div>
        </div>
    </header>

    <div class="matrix__table-container">
        <table class="deck-table matrix__table">
            <thead>
                <tr>
                    <th class="matrix__th matrix__th--checkbox">
                        <div class="matrix__header-checks">
                            <input type="checkbox" class="matrix__checkbox-all" checked="@IsAllVisibleSelected" @onchange="ToggleSelectAll" />
                            @if (SelectedCount > 0)
                            {
                                <button class="matrix__deselect-all" @onclick="ClearSelection"></button>
                            }
                        </div>
                    </th>
                    <th class="matrix__th matrix__th--id">ID</th>
                    <th class="matrix__th matrix__th--queue">Queue</th>
                    <th class="matrix__th matrix__th--type">Type</th>
                    <th class="matrix__th matrix__th--priority">Priority</th>
                    <th class="matrix__th matrix__th--user">User</th>
                    <th class="matrix__th matrix__th--status">Status</th>
                    <th class="matrix__th matrix__th--progress">Progress</th>
                    <th class="matrix__th matrix__th--attempts">Try</th>
                    <th class="matrix__th matrix__th--duration">Duration</th>
                    <th class="matrix__th matrix__th--actions">Actions</th>
                </tr>
            </thead>
            <tbody>
                <Virtualize Items="@FilteredJobs" Context="job" OverscanCount="10" ItemSize="45">
                    <ItemContent>
                        <JobRow @key="job.Id"
                                Job="job"
                                IsSelected="@_selectedJobIds.Contains(job.Id)"
                                OnSelectionChanged="@(isSelected => ToggleSelection(job.Id, isSelected))"
                                OnCancelRequested="HandleCancelRequest"
                                OnRestartRequested="HandleRestartRequest"
                                OnSelected="HandleJobSelected" />
                    </ItemContent>
                    <Placeholder>
                        <tr><td colspan="11" class="matrix__loading">Loading...</td></tr>
                    </Placeholder>
                    <EmptyContent>
                        <tr><td colspan="11" class="matrix__empty">No jobs found.</td></tr>
                    </EmptyContent>
                </Virtualize>
            </tbody>
        </table>
    </div>
</section>