@using Microsoft.AspNetCore.Components.Web.Virtualization
@using ChokaQ.TheDeck.Models
@using ChokaQ.Abstractions.Enums
@using ChokaQ.TheDeck.UI.Components.JobMatrix.JobRow
@namespace ChokaQ.TheDeck.UI.Components.JobMatrix

<section class="matrix">
    <!-- Toolbar -->
    <header class="matrix__toolbar">
        <div class="matrix__search-container">
             <div class="matrix__search-box">
                 <span class="matrix__search-label">SEARCH</span>
                 <input type="text"
                        class="matrix__search-input"
                        placeholder="ID, Type, Queue..."
                        @bind="_searchQuery"
                        @bind:event="oninput" />
                 @if (!string.IsNullOrEmpty(_searchQuery))
                 {
                     <span class="matrix__search-count">@FilteredJobs.Count</span>
                     <button class="matrix__search-clear" @onclick="() => _searchQuery = string.Empty">X</button>
                 }
             </div>
        </div>
        
        <div class="matrix__controls">
             @if (SelectedCount > 0)
             {
                  <span class="deck-badge matrix__selection-badge">@SelectedCount selected</span>
             }
             
             @if (IsConnected)
             {
                  <span class="matrix__status-label matrix__status-label--online">ONLINE</span>
             }
             else
             {
                  <span class="matrix__status-label matrix__status-label--offline">OFFLINE</span>
             }
             
             <button class="deck-btn" @onclick="OnClearHistory">Clear</button>
        </div>
    </header>
    
    <!-- Bulk Actions -->
    @if (SelectedCount > 0)
    {
        <div class="matrix__bulk-actions">
            <span class="matrix__bulk-label">BULK:</span>
            <button class="deck-btn deck-btn-primary" @onclick="RestartSelected">Retry All</button>
            <button class="deck-btn deck-btn-danger" @onclick="CancelSelected">Cancel All</button>
            
            <div class="matrix__bulk-priority">
                <span class="matrix__bulk-label">PRIORITY:</span>
                <input type="number" class="matrix__bulk-input" @bind="_bulkPriorityValue" />
                <button class="deck-btn matrix__bulk-apply" @onclick="SetPrioritySelected">Apply</button>
            </div>
            
            <button class="matrix__deselect" @onclick="ClearSelection">Deselect All</button>
        </div>
    }

    <!-- Table -->
    <div class="matrix__table-container">
        <table class="deck-table matrix__table">
            <thead>
                <tr>
                    <th class="matrix__th matrix__th--checkbox">
                        <input type="checkbox" checked="@IsAllVisibleSelected" @onchange="ToggleSelectAll" />
                    </th>
                    <th class="matrix__th matrix__th--id">ID</th>
                    <th class="matrix__th matrix__th--queue">Queue</th>
                    <th class="matrix__th matrix__th--type">Type</th>
                    <th class="matrix__th matrix__th--priority">Pri</th>
                    <th class="matrix__th matrix__th--user">User</th>
                    <th class="matrix__th matrix__th--status">Status</th>
                    <th class="matrix__th matrix__th--progress">Progress</th>
                    <th class="matrix__th matrix__th--attempts">Att.</th>
                    <th class="matrix__th matrix__th--duration">Duration</th>
                    <th class="matrix__th matrix__th--actions">Actions</th>
                </tr>
            </thead>
            <tbody>
                <Virtualize Items="@FilteredJobs" Context="job" OverscanCount="10" ItemSize="45">
                    <ItemContent>
                        <JobRow @key="job.Id"
                                Job="job"
                                IsSelected="@_selectedJobIds.Contains(job.Id)"
                                OnSelectionChanged="@(isSelected => ToggleSelection(job.Id, isSelected))"
                                OnCancelRequested="HandleCancelRequest"
                                OnRestartRequested="HandleRestartRequest"
                                OnSelected="HandleJobSelected" />
                    </ItemContent>
                    <Placeholder>
                         <tr><td colspan="11" class="matrix__loading">Loading...</td></tr>
                    </Placeholder>
                    <EmptyContent>
                         <tr><td colspan="11" class="matrix__empty">No jobs found.</td></tr>
                    </EmptyContent>
                </Virtualize>
            </tbody>
        </table>
    </div>
</section>
