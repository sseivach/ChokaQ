@using ChokaQ.Abstractions
@using ChokaQ.Abstractions.Workers
@inject IWorkerManager WorkerManager

<div style="display: flex; flex-direction: column; gap: 1rem; height: 100%; justify-content: center;">
    
    <div style="display: flex; align-items: center; gap: 0.5rem;">
        <div style="font-weight: bold; font-size: 0.85rem; min-width: 120px;">WORKERS</div>
        <input type="number"
               style="width: 70px; background: var(--sector-bg); border: 1px solid var(--sector-border-color); color: var(--deck-text-color); font-family: var(--deck-font-family); padding: 0.25rem; font-size: 0.85rem;"
               min="0"
               max="100"
               @bind="DesiredWorkers" />
        <span style="opacity: 0.6; font-size: 0.8rem;">(Active: @WorkerManager.ActiveWorkers)</span>
    </div>

    <div style="display: flex; align-items: center; gap: 0.5rem;">
        <div style="font-weight: bold; font-size: 0.85rem; min-width: 120px;">RETRIES</div>
        <select style="width: 60px; background: var(--sector-bg); border: 1px solid var(--sector-border-color); color: var(--deck-text-color); font-family: var(--deck-font-family); padding: 0.25rem; font-size: 0.85rem;"
                @bind="MaxRetries">
            @for (int i = 1; i <= 10; i++)
            {
                <option value="@i">@i</option>
            }
        </select>
    </div>

    <div style="display: flex; align-items: center; gap: 0.5rem;">
        <div style="font-weight: bold; font-size: 0.85rem; min-width: 120px;">BASE DELAY (S)</div>
        <input type="number"
               style="width: 70px; background: var(--sector-bg); border: 1px solid var(--sector-border-color); color: var(--deck-text-color); font-family: var(--deck-font-family); padding: 0.25rem; font-size: 0.85rem;"
               min="1"
               max="3600"
               @bind="RetryDelaySeconds" />
    </div>

    <div style="display: flex; justify-content: flex-end;">
        <button class="deck-btn deck-btn-primary" @onclick="ApplyChanges">
            Apply
        </button>
    </div>

</div>

@code {
    [Parameter] public EventCallback OnSettingsApplied { get; set; }

    public int DesiredWorkers { get; set; }
    public int MaxRetries { get; set; }
    public int RetryDelaySeconds { get; set; }

    protected override void OnInitialized()
    {
        DesiredWorkers = WorkerManager.TotalWorkers;
        MaxRetries = WorkerManager.MaxRetries;
        RetryDelaySeconds = WorkerManager.RetryDelaySeconds;
    }

    private async Task ApplyChanges()
    {
        // Validation logic
        if (RetryDelaySeconds < 1) RetryDelaySeconds = 1;
        if (DesiredWorkers < 0) DesiredWorkers = 0;
        if (DesiredWorkers > 100) DesiredWorkers = 100;

        // Apply to Singleton Manager
        WorkerManager.UpdateWorkerCount(DesiredWorkers);
        WorkerManager.MaxRetries = MaxRetries;
        WorkerManager.RetryDelaySeconds = RetryDelaySeconds;

        await OnSettingsApplied.InvokeAsync();
    }
}
